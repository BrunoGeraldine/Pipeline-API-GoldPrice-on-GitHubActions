name: Gold Price Data Pipeline

on:
  schedule:
    # Executa diariamente √†s 02:00 UTC (ap√≥s fechamento mercado US)
    - cron: "0 2 * * *"
  
  # Permite execu√ß√£o manual
  workflow_dispatch:
    inputs:
      backup:
        description: 'Criar backup completo (3 anos)?'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  update-gold-data:
    runs-on: ubuntu-latest

    env:
      PYTHONPATH: src
    
    steps:
      # --------------------------------------------------
      # Checkout
      # --------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --------------------------------------------------
      # Setup Python
      # --------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      # --------------------------------------------------
      # Install dependencies
      # --------------------------------------------------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # --------------------------------------------------
      # Debug environment
      # --------------------------------------------------
      - name: Debug environment
        run: |
          echo "üìÅ Working directory:"
          pwd
          echo ""
          echo "üìÇ Project structure:"
          ls -la
          echo ""
          echo "üìÇ Data directory:"
          ls -la dataset/ || echo "‚ö†Ô∏è Data directory n√£o existe"
          echo ""
          echo "üêç Python version:"
          python --version
          echo ""
          echo "üì¶ Installed packages:"
          pip list | grep -E "yfinance|pandas|pyarrow"

      # --------------------------------------------------
      # Create backup (if requested or first run)
      # --------------------------------------------------
      - name: Create historical backup
        if: github.event.inputs.backup == 'true' || !hashFiles('dataset/last_update.txt')
        run: |
          echo "=" * 60
          echo "üîÑ CRIANDO BACKUP HIST√ìRICO (3 ANOS)"
          echo "=" * 60
          python src/extract_gold_data.py --backup
        

      # --------------------------------------------------
      # Incremental update
      # --------------------------------------------------
      - name: Incremental update
        if: github.event.inputs.backup != 'true' && hashFiles('dataset/last_update.txt')
        run: |
          echo "=" * 60
          echo "üîÑ ATUALIZA√á√ÉO INCREMENTAL"
          echo "=" * 60
          python src/extract_gold_data.py
        

      # --------------------------------------------------
      # Verify data files
      # --------------------------------------------------
      - name: Verify data files
        run: |
          echo "üìä Verificando arquivos gerados:"
          ls -lh dataset/
          echo ""
          
          if [ -f "dataset/gold_backup.parquet" ]; then
            echo "‚úÖ Backup file exists"
            python -c "import pandas as pd; df=pd.read_parquet('dataset/gold_backup.parquet'); print(f'Backup records: {len(df)}'); print(f'Date range: {df[\"date\"].min()} to {df[\"date\"].max()}')"
          fi
          
          if [ -f "dataset/gold_daily.parquet" ]; then
            echo "‚úÖ Daily file exists"
            python -c "import pandas as pd; df=pd.read_parquet('dataset/gold_daily.parquet'); print(f'Daily records: {len(df)}'); print(f'Latest date: {df[\"date\"].max()}')"
          fi
          
          if [ -f "dataset/last_update.txt" ]; then
            echo "‚úÖ Checkpoint file exists"
            echo "Last update: $(cat dataset/last_update.txt)"
          fi
        

      # --------------------------------------------------
      # Commit changes
      # --------------------------------------------------
      - name: Commit data updates
        run: |
          echo "=" * 60
          echo "üíæ COMMITANDO MUDAN√áAS"
          echo "=" * 60
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add dataset/
          
          if git diff --staged --quiet; then
            echo "‚ö†Ô∏è Nenhuma mudan√ßa para commitar"
          else
            COMMIT_MSG="chore(data): update gold prices - $(date +'%Y-%m-%d') [skip ci]"
            git commit -m "$COMMIT_MSG"
            echo "‚úÖ Commit criado: $COMMIT_MSG"
          fi

      # --------------------------------------------------
      # Push changes
      # --------------------------------------------------
      - name: Push changes
        run: |
          if git log origin/main..HEAD --oneline | grep -q .; then
            echo "üì§ Pushing changes..."
            git push
            echo "‚úÖ Push completed"
          else
            echo "‚ö†Ô∏è Nenhuma mudan√ßa para fazer push"
          fi

      # --------------------------------------------------
      # Summary
      # --------------------------------------------------
      - name: Pipeline summary
        if: always()
        run: |
          echo "=" * 60
          echo "üìä RESUMO DA PIPELINE"
          echo "=" * 60
          echo "‚úÖ Pipeline executada com sucesso"
          echo "üìÖ Data: $(date +'%Y-%m-%d %H:%M:%S UTC')"
          
          if [ -f "dataset/last_update.txt" ]; then
            echo "üìå √öltima atualiza√ß√£o: $(cat dataset/last_update.txt)"
          fi
          
          if [ -f "dataset/gold_daily.parquet" ]; then
            python -c "import pandas as pd; df=pd.read_parquet('dataset/gold_daily.parquet'); print(f'üìä Total de registros: {len(df)}'); latest=df.loc[df['date'].idxmax()]; print(f'üí∞ √öltimo fechamento: \${latest[\"closed_price\"]:.2f} em {latest[\"date\"].date()}')"
          fi