name: Gold Price Data Pipeline

on:
  schedule:
    # Executa diariamente Ã s 02:00 UTC (apÃ³s fechamento mercado US)
    - cron: "0 2 * * *"
  
  # Permite execuÃ§Ã£o manual
  workflow_dispatch:
    inputs:
      backup:
        description: 'Criar backup completo (3 anos)?'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  update-gold-data:
    runs-on: ubuntu-latest
    
    steps:
      # --------------------------------------------------
      # Checkout
      # --------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --------------------------------------------------
      # Setup Python
      # --------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      # --------------------------------------------------
      # Install dependencies
      # --------------------------------------------------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # --------------------------------------------------
      # Debug environment
      # --------------------------------------------------
      - name: Debug environment
        run: |
          echo "ğŸ“ Working directory:"
          pwd
          echo ""
          echo "ğŸ“‚ Project structure:"
          ls -la
          echo ""
          echo "ğŸ“‚ Data directory:"
          ls -la dataset/ || echo "âš ï¸ Data directory nÃ£o existe"
          echo ""
          echo "ğŸ Python version:"
          python --version
          echo ""
          echo "ğŸ“¦ Installed packages:"
          pip list | grep -E "yfinance|pandas|pyarrow"

      # --------------------------------------------------
      # Create backup (if requested or first run)
      # --------------------------------------------------
      - name: Create historical backup
        if: github.event.inputs.backup == 'true' || !hashFiles('dataset/last_update.txt')
        run: |
          echo "=" * 60
          echo "ğŸ”„ CRIANDO BACKUP HISTÃ“RICO (3 ANOS)"
          echo "=" * 60
          python src/extract_gold_data.py --backup

      # --------------------------------------------------
      # Incremental update
      # --------------------------------------------------
      - name: Incremental update
        if: github.event.inputs.backup != 'true' && hashFiles('dataset/last_update.txt')
        run: |
          echo "=" * 60
          echo "ğŸ”„ ATUALIZAÃ‡ÃƒO INCREMENTAL"
          echo "=" * 60
          python src/extract_gold_data.py

      # --------------------------------------------------
      # Verify data files
      # --------------------------------------------------
      - name: Verify data files
        run: |
          echo "ğŸ“Š Verificando arquivos gerados:"
          ls -lh dataset/
          echo ""
          
          if [ -f "dataset/gold_backup.parquet" ]; then
            echo "âœ… Backup file exists"
            python -c "import pandas as pd; df=pd.read_parquet('dataset/gold_backup.parquet'); print(f'Backup records: {len(df)}'); print(f'Date range: {df[\"date\"].min()} to {df[\"date\"].max()}')"
          fi
          
          if [ -f "dataset/gold_daily.parquet" ]; then
            echo "âœ… Daily file exists"
            python -c "import pandas as pd; df=pd.read_parquet('dataset/gold_daily.parquet'); print(f'Daily records: {len(df)}'); print(f'Latest date: {df[\"date\"].max()}')"
          fi
          
          if [ -f "dataset/last_update.txt" ]; then
            echo "âœ… Checkpoint file exists"
            echo "Last update: $(cat dataset/last_update.txt)"
          fi

      # --------------------------------------------------
      # Commit changes
      # --------------------------------------------------
      - name: Commit data updates
        run: |
          echo "=" * 60
          echo "ğŸ’¾ COMMITANDO MUDANÃ‡AS"
          echo "=" * 60
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add dataset/
          
          if git diff --staged --quiet; then
            echo "âš ï¸ Nenhuma mudanÃ§a para commitar"
          else
            COMMIT_MSG="chore(data): update gold prices - $(date +'%Y-%m-%d') [skip ci]"
            git commit -m "$COMMIT_MSG"
            echo "âœ… Commit criado: $COMMIT_MSG"
          fi

      # --------------------------------------------------
      # Push changes
      # --------------------------------------------------
      - name: Push changes
        run: |
          if git log origin/main..HEAD --oneline | grep -q .; then
            echo "ğŸ“¤ Pushing changes..."
            git push
            echo "âœ… Push completed"
          else
            echo "âš ï¸ Nenhuma mudanÃ§a para fazer push"
          fi

      # --------------------------------------------------
      # Summary
      # --------------------------------------------------
      - name: Pipeline summary
        if: always()
        run: |
          echo "=" * 60
          echo "ğŸ“Š RESUMO DA PIPELINE"
          echo "=" * 60
          echo "âœ… Pipeline executada com sucesso"
          echo "ğŸ“… Data: $(date +'%Y-%m-%d %H:%M:%S UTC')"
          
          if [ -f "dataset/last_update.txt" ]; then
            echo "ğŸ“Œ Ãšltima atualizaÃ§Ã£o: $(cat dataset/last_update.txt)"
          fi
          
          if [ -f "dataset/gold_daily.parquet" ]; then
            python -c "import pandas as pd; df=pd.read_parquet('dataset/gold_daily.parquet'); print(f'ğŸ“Š Total de registros: {len(df)}'); latest=df.loc[df['date'].idxmax()]; print(f'ğŸ’° Ãšltimo fechamento: \${latest[\"closed_price\"]:.2f} em {latest[\"date\"].date()}')"
          fi